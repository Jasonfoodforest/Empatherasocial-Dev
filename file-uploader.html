<!DOCTYPE html>
<html>
<head><title>Upload to Firebase</title></head>
<body>
  <h2>Upload a File</h2>
  <input type="file" id="fileInput" />
  <button onclick="uploadFile()">Upload File</button>
  <p id="status"></p>
  <script type="module">
    import { storage, db } from './firebase-config.js';
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    console.log("Uploader initialized.");
    console.log("Storage object:", storage);

    async function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const statusEl = document.getElementById('status');

      if (!file) {
        statusEl.textContent = "No file selected.";
        return;
      }

      const path = `uploads/${file.name}`;
      const storageRef = ref(storage, path);
      const uploadTask = uploadBytesResumable(storageRef, file);

      uploadTask.on('state_changed', 
        snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          statusEl.textContent = `Uploading... ${Math.floor(progress)}%`;
        }, 
        error => {
          console.error("Upload failed", error);
          statusEl.textContent = "Upload failed.";
        }, 
        async () => {
          const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
          statusEl.textContent = `Upload complete!\n${downloadURL}`;

          // Save to Firestore
          try {
            await addDoc(collection(db, "uploads"), {
              name: file.name,
              url: downloadURL,
              createdAt: serverTimestamp()
            });
            console.log("Saved to Firestore.");
          } catch (err) {
            console.error("Error writing to Firestore:", err);
          }
        }
      );
    }
  </script>
</body>
</html>
